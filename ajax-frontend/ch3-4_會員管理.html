<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        table, td {
            border: 1px solid black;
            text-align: center;
        }
        td {
            width: 100px;
        }
        img {
            width: 100px;
        }
        .create_div {
            zoom: 1.5;
        }
    </style>
</head>
<body>
    <h1>新增會員</h1>
    <div class="create_div">
        <div>姓名: <input type="text" id="memberName"></div>
        <div><label>管理員: <input type="checkbox" id="is_admin"></label></div>
        <div>email: <input type="text" id="email"></div>
        <div>照片: <input type="file" id="photo"></div>
        <div><button id="create_btn">新增(僅新增文字)</button></div>
        <div><button id="create_btn_with_img">新增(包含圖片)</button></div>
    </div>

    <script type="module">
        import http from "./my_module/http.js";

        const memberName = document.querySelector("#memberName");
        const isAdmin = document.querySelector("#is_admin");
        const email = document.querySelector("#email");
        const photo = document.querySelector("#photo");
        const createBtn = document.querySelector("#create_btn");
        const createBtnWithImg = document.querySelector("#create_btn_with_img");
        
        // 僅新增文字
        createBtn.addEventListener("click", async () => {
            const member = {
                memberName: memberName.value,
                isAdmin: isAdmin.checked,
                email: email.value
            }
            // RESTful 重點，送出請求且附帶request body
            const newMember = await http.post("/api/members", member);
            console.log(newMember);

            // 頁面渲染
            const dataHome = document.querySelector("#data_home");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${newMember.memberId}</td>
                <td>${newMember.memberName}</td>
                <td>${newMember.isAdmin ? "Y" : "N"}</td>
                <td>${newMember.email}</td>
                <td><img src="${'data:image/png;base64,' + newMember.memberPhoto}"></td>
                <td><button data-action>刪除</button></td>
            `;
            dataHome.append(tr);
        });

        


    </script>

    <table>
        <thead>
                <tr>
                    <td>ID</td>
                    <td>會員名稱</td>
                    <td>是否為管理員</td>
                    <td>Email</td>
                    <td>照片</td>
                    <td>操作</td>
                </tr>
        </thead>
        <tbody id="data_home">
            <tr>
                <td>1</td>
                <td>Alice</td>
                <td>Y</td>
                <td>AAA</td>
                <td>AAA</td>
                <td><button>刪除</button></td>
            </tr>
        </tbody>
    </table>

    <script type="module">
        import http from "./my_module/http.js";

        const dataHome = document.querySelector("#data_home");

        const getAllMembers = async () => {
            const members = await http.get("/api/members");
            
            // 未來會使用vue，把資料渲染到畫面
            let outputHtml = "";
            for (let m of members) {
                outputHtml += 
                    `
                        <tr data-id="${m.memberId}">
                            <td>${m.memberId}</td>
                            <td>${m.memberName}</td>
                            <td>${m.isAdmin ? "Y" : "N"}</td>
                            <td>${m.email}</td>
                            <td><img src="${'data:image/png;base64,' + m.memberPhoto}"></td>
                            <td><button data-action="delete">刪除</button></td>
                        </tr>
                    `    
            }
            dataHome.innerHTML = outputHtml;
        }
        getAllMembers();
            
        const deleteMemberById = async (memberId) => {
            const doIt = confirm("確定要刪除嗎?");
            if (!doIt) return;
            
            try {
                // 打刪除的API (課堂重點)
                await http.delete(`/api/members/${memberId}`);

                // 刪除成功後更新畫面(未來由vue處理)
                document.querySelector(`[data-id="${memberId}"]`).remove();
            } catch (err) {
                alert("刪除失敗" + err.message);
            }
        }

        setTimeout(() => {
            document.querySelectorAll("[data-action='delete']").forEach(
                btn => btn.addEventListener("click", () => 
                    deleteMemberById(btn.parentElement.parentElement.dataset.id)
                )
            )
        }, 100);

            

    </script>
</body>
</html>